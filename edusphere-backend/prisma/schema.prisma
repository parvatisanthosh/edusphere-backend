// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & WORKSPACE MODELS
// ============================================

model User {
  id          String   @id @default(uuid())
  name        String
  email       String   @unique
  password    String
  teamRole    String?  @map("team_role")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // GitHub Integration Fields
  githubUsername    String?   @map("github_username")
  githubToken       String?   @map("github_token")
  githubConnectedAt DateTime? @map("github_connected_at")
  lastGithubSync    DateTime? @map("last_github_sync")
  
  // File Upload Fields
  profilePictureUrl String?   @map("profile_picture_url")
  resumeUrl         String?   @map("resume_url")

  // Relationships
  workspaces           Workspace[]
  invites              Invite[]
  teams                Team[]
  chats                Chat[]
  documents            Document[]
  student              Student?
  mentorSessions       MentorSession[] @relation("MentorSessions")
  evaluationsGiven     InternshipEvaluation[] @relation("EvaluatorEvaluations")


   chatRoomsCreated       ChatRoom[]               @relation("ChatRoomCreator")
  chatParticipations     ChatParticipant[]        @relation("UserChatParticipant")
  chatMessages           ChatMessage[]            @relation("UserChatMessages")
  forumsCreated          DiscussionForum[]        @relation("ForumCreator")
  forumPosts             ForumPost[]              @relation("UserForumPosts")
  sentMessages           Message[]                @relation("SentMessages")
  receivedMessages       Message[]                @relation("ReceivedMessages")
  announcements          Announcement[]           @relation("AnnouncementPoster")
  notificationPreferences NotificationPreference[] @relation("UserNotificationPreferences")
   mentor             Mentor?             @relation("UserMentor")
  faculty            Faculty?            @relation("UserFaculty")
  userNotifications  UserNotification[]  @relation("UserUserNotifications")

  @@map("users")
}

model Workspace {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now()) @map("created_at")
  folderId  String?  @map("folder_id")
  teamId    String?  @map("team_id")
  userId    String   @map("user_id")

  user    User      @relation(fields: [userId], references: [id])
  folder  Folder?   @relation(fields: [folderId], references: [id])
  team    Team?     @relation(fields: [teamId], references: [id])
  chats   Chat[]
  invites Invite[]

  @@map("workspaces")
}

model Folder {
  id         String      @id @default(uuid())
  name       String
  workspaces Workspace[]

  @@map("folders")
}

model Team {
  id         String      @id @default(uuid())
  name       String
  workspaces Workspace[]
  users      User[]

  @@map("teams")
}

model Invite {
  id          String    @id @default(uuid())
  inviteId    String    @unique @map("invite_id")
  workspaceId String    @map("workspace_id")
  type        String
  inviterId   String    @map("inviter_id")

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  inviter   User      @relation(fields: [inviterId], references: [id])

  @@map("invites")
}

model Chat {
  id          String    @id @default(uuid())
  duration    Int?
  startedAt   DateTime? @map("started_at")
  endedAt     DateTime? @map("ended_at")
  workspaceId String    @map("workspace_id")
  userId      String    @map("user_id")

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@map("chats")
}

// ============================================
// STUDENT & PROFILE MODELS
// ============================================

model Student {
  id          String    @id @default(uuid())
  userId      String    @unique @map("user_id")
  rollNumber  String?   @unique @map("roll_number")
  department  String?
  semester    Int?
  cgpa        Float?
  dateOfBirth DateTime? @map("date_of_birth")
  phone       String?
  approved    Boolean   @default(false)
  approvedAt  DateTime? @map("approved_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relationships
  user                 User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  profile              Profile?
  applications         InternshipApplication[]
  enrollments          CourseEnrollment[]
  projects             PortfolioProject[]
  mentorSessions       MentorSession[]
  reviews              MentorReview[]
  logbookEntries       LogbookEntry[]
  certificates         Certificate[]
  learningProgress     StudentLearningProgress[]
  certifications       Certification[]
  studentSkills        StudentSkill[]
  cvGenerations        CVGeneration[]
   mentorReviews MentorReview[] @relation("StudentMentorReviews")
  credits       Credit?        @relation("StudentCredits")

  @@map("students")
}

model Profile {
  id         String    @id @default(uuid())
  studentId  String    @unique @map("student_id")
  bio        String?
  gender     String?
  dob        DateTime?
  avatarUrl  String?   @map("avatar_url")
  github     String?
  linkedin   String?
  skills     String?   // JSON array stored as string
  interests  String?   // JSON array stored as string
  resumeUrl  String?   @map("resume_url")
  department String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

// ============================================
// INTERNSHIP MODELS
// ============================================

model Internship {
  id                  String    @id @default(uuid())
  title               String
  description         String
  companyName         String    @map("company_name")
  location            String
  type                String    // remote, onsite, hybrid
  duration            Int       // in weeks
  stipend             Int?
  requiredSkills      String    // JSON array as string
  startDate           DateTime? @map("start_date")
  endDate             DateTime? @map("end_date")
  applicationDeadline DateTime? @map("application_deadline")
  isActive            Boolean   @default(true) @map("is_active")
  postedBy            String    @map("posted_by")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  applications InternshipApplication[]
  evaluations  InternshipEvaluation[]
  chatRooms ChatRoom[]

  @@map("internships")
}

model InternshipApplication {
  id              String    @id @default(uuid())
  studentId       String    @map("student_id")
  internshipId    String    @map("internship_id")
  status          String    @default("pending") // pending, accepted, rejected, withdrawn
  coverLetter     String?   @map("cover_letter")
  resumeUrl       String?   @map("resume_url")
  appliedAt       DateTime  @default(now()) @map("applied_at")
  reviewedAt      DateTime? @map("reviewed_at")
  rejectionReason String?   @map("rejection_reason")

  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  internship Internship @relation(fields: [internshipId], references: [id], onDelete: Cascade)

  @@unique([studentId, internshipId])
  @@map("internship_applications")
}

model InternshipEvaluation {
  id           String   @id @default(uuid())
  internshipId String   @map("internship_id")
  evaluatorId  String   @map("evaluator_id")
  facultyId    String   @map("faculty_id")
  rubricJson   String   @map("rubric_json") // JSON stored as string
  comments     String?
  finalScore   Float    @map("final_score")
  createdAt    DateTime @default(now()) @map("created_at")

  internship Internship @relation(fields: [internshipId], references: [id], onDelete: Cascade)
  evaluator  User       @relation("EvaluatorEvaluations", fields: [evaluatorId], references: [id])

  @@map("internship_evaluations")
}

// ============================================
// COURSE MODELS
// ============================================

model Course {
  id           String   @id @default(uuid())
  title        String
  description  String
  type         String   // technical, soft_skill, domain
  price        Float?
  thumbnail    String?
  instructorId String   @map("instructor_id")
  thumbnailUrl String?  @map("thumbnail_url")
  createdAt    DateTime @default(now()) @map("created_at")

  enrollments CourseEnrollment[]
  checkpoints Checkpoint[]

  @@map("courses")
}

model CourseEnrollment {
  id              String    @id @default(uuid())
  studentId       String    @map("student_id")
  courseId        String    @map("course_id")
  enrolledAt      DateTime  @default(now()) @map("enrolled_at")
  progressPercent Int       @default(0) @map("progress_percent")
  completedAt     DateTime? @map("completed_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@map("course_enrollments")
}

model Checkpoint {
  id          String  @id @default(uuid())
  courseId    String  @map("course_id")
  title       String
  description String?
  resourceUrl String? @map("resource_url")

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("checkpoints")
}

// ============================================
// PORTFOLIO & PROJECTS
// ============================================

model PortfolioProject {
  id           String    @id @default(uuid())
  studentId    String    @map("student_id")
  title        String
  description  String
  githubUrl    String?   @map("github_url")
  liveUrl      String?   @map("live_url")
  tags         String?   // JSON array as string
  createdAt    DateTime  @default(now()) @map("created_at")
  
  // GitHub Integration Fields
  source       String    @default("manual") // manual, github
  githubRepoId String?   @map("github_repo_id")
  lastSyncedAt DateTime? @map("last_synced_at")
  stars        Int       @default(0)
  forks        Int       @default(0)
  language     String?

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("portfolio_projects")
}

// ============================================
// MENTOR & SESSIONS
// ============================================

model MentorSession {
  id          String    @id @default(uuid())
  studentId   String    @map("student_id")
  mentorId    String    @map("mentor_id")
  scheduledAt DateTime  @map("scheduled_at")
  status      String    @default("scheduled") // scheduled, completed, cancelled
  meetingLink String?   @map("meeting_link")
  createdAt   DateTime  @default(now()) @map("created_at")

  student Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  mentor  User           @relation("MentorSessions", fields: [mentorId], references: [id])
  reviews MentorReview[]
  mentor User @relation("MentorMentorSessions", fields: [mentorId], references: [id])

  @@map("mentor_sessions")
}

model MentorReview {
  id        String  @id @default(uuid())
  sessionId String  @map("session_id")
  studentId String  @map("student_id")
  rating    Float
  review    String?

  session MentorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("mentor_reviews")
}

// ============================================
// LOGBOOK & CERTIFICATES
// ============================================

model LogbookEntry {
  id          String   @id @default(uuid())
  studentId   String   @map("student_id")
  date        DateTime
  task        String
  hours       Int
  description String
  proofUrl    String?  @map("proof_url")
  createdAt   DateTime @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("logbook_entries")
}

model Certificate {
  id             String   @id @default(uuid())
  studentId      String   @map("student_id")
  title          String
  issuedAt       DateTime @default(now()) @map("issued_at")
  certificateUrl String   @map("certificate_url")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("certificates")
}

// ============================================
// LEARNING PROGRESS & ROADMAP
// ============================================

model StudentLearningProgress {
  id           String    @id @default(uuid())
  studentId    String    @map("student_id")
  profileId    String    @map("profile_id")
  isCompleted  Boolean   @default(false) @map("is_completed")
  completedAt  DateTime? @map("completed_at")
  checkpointId String    @map("checkpoint_id")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("student_learning_progress")
}

model Roadmap {
  id          String  @id @default(uuid())
  title       String
  description String?
  domain      String

  @@map("roadmaps")
}

// ============================================
// DAY 3 MODELS - NEW FEATURES
// ============================================

model Certification {
  id            String    @id @default(uuid())
  studentId     String    @map("student_id")
  title         String
  issuer        String?
  issueDate     DateTime? @map("issue_date")
  expiryDate    DateTime? @map("expiry_date")
  credentialId  String?   @map("credential_id")
  credentialUrl String?   @map("credential_url")
  source        String    @default("manual") // manual, email, ai
  documentUrl   String?   @map("document_url")
  verified      Boolean   @default(false)
  metadata      String?   // JSON stored as string
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("certifications")
}

model Skill {
  id        String   @id @default(uuid())
  name      String   @unique
  category  String?
  createdAt DateTime @default(now()) @map("created_at")

  studentSkills StudentSkill[]

  @@map("skills")
}

model StudentSkill {
  id               String   @id @default(uuid())
  studentId        String   @map("student_id")
  skillId          String   @map("skill_id")
  proficiencyLevel Int      // 1-5
  yearsExperience  Float?   @map("years_experience")
  source           String   @default("manual") // manual, github, linkedin
  createdAt        DateTime @default(now()) @map("created_at")

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([studentId, skillId])
  @@map("student_skills")
}

model CVGeneration {
  id           String   @id @default(uuid())
  studentId    String   @map("student_id")
  templateName String   @map("template_name")
  fileUrl      String   @map("file_url")
  format       String   // html, pdf, docx
  generatedAt  DateTime @default(now()) @map("generated_at")
  metadata     String?  // JSON stored as string

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("cv_generations")
}

model Document {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  filename         String
  originalFilename String   @map("original_filename")
  fileUrl          String   @map("file_url")
  fileType         String?  @map("file_type")
  fileSize         BigInt?  @map("file_size")
  category         String?  // resume, certificate, transcript, general
  uploadedAt       DateTime @default(now()) @map("uploaded_at")
  metadata         String?  // JSON stored as string

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("documents")
}

// ============================================
// CHAT & DISCUSSION MODELS
// ============================================

model ChatRoom {
  id           String   @id @default(uuid())
  name         String
  type         String   // group, direct, internship
  internshipId String?  @map("internship_id")
  createdBy    String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")

  creator      User              @relation("ChatRoomCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  internship   Internship?       @relation(fields: [internshipId], references: [id], onDelete: Cascade)
  participants ChatParticipant[]
  messages     ChatMessage[]

  @@map("chat_rooms")
}

model ChatParticipant {
  id         String    @id @default(uuid())
  chatRoomId String    @map("chat_room_id")
  userId     String    @map("user_id")
  role       String    @default("member")
  joinedAt   DateTime  @default(now()) @map("joined_at")
  lastReadAt DateTime? @map("last_read_at")

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  user     User     @relation("UserChatParticipant", fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_participants")
}

model ChatMessage {
  id            String   @id @default(uuid())
  chatRoomId    String   @map("chat_room_id")
  senderId      String   @map("sender_id")
  message       String
  attachmentUrl String?  @map("attachment_url")
  isEdited      Boolean  @default(false) @map("is_edited")
  createdAt     DateTime @default(now()) @map("created_at")

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation("UserChatMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model DiscussionForum {
  id          String   @id @default(uuid())
  topic       String
  description String?
  category    String
  isPinned    Boolean  @default(false) @map("is_pinned")
  isLocked    Boolean  @default(false) @map("is_locked")
  viewCount   Int      @default(0) @map("view_count")
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  creator User        @relation("ForumCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  posts   ForumPost[]

  @@map("discussion_forums")
}

model ForumPost {
  id           String    @id @default(uuid())
  forumId      String    @map("forum_id")
  userId       String    @map("user_id")
  parentPostId String?   @map("parent_post_id")
  content      String
  upvotes      Int       @default(0)
  createdAt    DateTime  @default(now()) @map("created_at")
  editedAt     DateTime? @map("edited_at")

  forum      DiscussionForum @relation(fields: [forumId], references: [id], onDelete: Cascade)
  user       User            @relation("UserForumPosts", fields: [userId], references: [id], onDelete: Cascade)
  parentPost ForumPost?      @relation("PostReplies", fields: [parentPostId], references: [id], onDelete: Cascade)
  replies    ForumPost[]     @relation("PostReplies")

  @@map("forum_posts")
}

model Message {
  id              String    @id @default(uuid())
  senderId        String    @map("sender_id")
  receiverId      String    @map("receiver_id")
  parentMessageId String?   @map("parent_message_id")
  subject         String?
  body            String
  isRead          Boolean   @default(false) @map("is_read")
  attachmentUrl   String?   @map("attachment_url")
  createdAt       DateTime  @default(now()) @map("created_at")
  deletedAt       DateTime? @map("deleted_at")

  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Announcement {
  id             String    @id @default(uuid())
  postedBy       String    @map("posted_by")
  title          String
  content        String
  targetAudience String    @map("target_audience")
  priority       String    @default("normal")
  expiresAt      DateTime? @map("expires_at")
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")

  poster User @relation("AnnouncementPoster", fields: [postedBy], references: [id], onDelete: Cascade)

  @@map("announcements")
}

model NotificationPreference {
  id                  String   @id @default(uuid())
  userId              String   @map("user_id")
  notificationId      String   @map("notification_id")
  emailEnabled        Boolean  @default(true) @map("email_enabled")
  smsEnabled          Boolean  @default(false) @map("sms_enabled")
  pushEnabled         Boolean  @default(true) @map("push_enabled")
  announcementNotify  Boolean  @default(true) @map("announcement_notify")
  messageNotify       Boolean  @default(true) @map("message_notify")
  applicationNotify   Boolean  @default(true) @map("application_notify")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user User @relation("UserNotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications_preferences")
}

// ============================================
// MENTOR & REVIEW MODELS (Image 7)
// ============================================

model Mentor {
  id        String  @id @default(uuid())
  userId    String  @unique @map("user_id")
  expertise String
  rating    Float   @default(0)
  bio       String?

  user     User            @relation("UserMentor", fields: [userId], references: [id], onDelete: Cascade)
  reviews  MentorReview[]  @relation("MentorReviews")
  sessions MentorSession[] @relation("MentorMentorSessions")

  @@map("mentors")
}

model MentorReview {
  id        String  @id @default(uuid())
  mentorId  String  @map("mentor_id")
  rating    Float
  reviews   String?
  studentId String  @map("student_id")

  mentor  Mentor  @relation("MentorReviews", fields: [mentorId], references: [id], onDelete: Cascade)
  student Student @relation("StudentMentorReviews", fields: [studentId], references: [id], onDelete: Cascade)

  @@map("mentorReviews")
}

model UserNotification {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  notificationId String    @map("notification_id")
  title          String
  message        String
  isRead         Boolean   @default(false)
  readAt         DateTime? @map("read_at")

  user User @relation("UserUserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notifications")
}

model Institution {
  id            String   @id @default(uuid())
  instituteName String   @map("instituteName")
  state         String?
  aisheId       String?  @unique @map("aishe_id")
  channelsId    String?  @map("channels_id")
  createdAt     DateTime @default(now()) @map("created_at")

  faculty Faculty[]

  @@map("institutions")
}

model Faculty {
  id           String  @id @default(uuid())
  instituteId  String  @map("institute_id")
  userId       String  @unique @map("user_id")
  name         String
  department   String?

  institution Institution @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  user        User        @relation("UserFaculty", fields: [userId], references: [id], onDelete: Cascade)

  @@map("faculty")
}

model Credit {
  id            String @id @default(uuid())
  studentId     String @unique @map("student_id")
  creditsEarned Float  @default(0) @map("credits_earned")

  student Student @relation("StudentCredits", fields: [studentId], references: [id], onDelete: Cascade)

  @@map("credits")
}